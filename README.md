# NN-based heightmap generator

## Содержание

- [Вступление](#introduction)
- [Входные и выходные данные](#in/out_data)
- [Пайплайн](#pipeline)
- [Модель](#model)
- [Результаты](#results)
- [Исходники](#source)

## <a id="introduction">Вступление</a>
С каждым днем требования к качеству создаваемых ландшафтов в кинематографической и игровой промышленностях становятся все больше, а наиболее популярные в
использовании методы процедурной генерации являются строго настроенными и слаборасширяемыми. Следовательно, такие алгоритмы нуждаются в частой доработке, а сами 
продукты их работы, по мере увеличения размеров, требуют все больше человеческого вмешательства. Таким образом, повышение качества, разнообразия и размера модели 
ландшафта влечет к большим затратам.   
Решением данной проблемы должен стать новый инструмент, способный к расширению и слабо привязанный к типу ландшафта. 
Целью данной работы является исследование применимости нейронных сетей для генерации реалистичных ландшафтных карт.

## <a id="in/out_data">Входные/Выходные данные</a>
На вход пайплайну подается карта высот некоторой поверхности, удовлетворяющая следующим требованиям:   
   + Большая размерность (Площадь более 10^7 пикселей)   
   + Отсутстиве надписей или других мешающих артефактов
   + Grayscale
   
В моем случае эксперименты проводились над картой высот Земли. Её разрешешение: 21600х10800.   
На практике может быть подана любая карта. 
Были проведены поиски карты высот Луны и Марса, но найденные картинки не соответствовали требованиям.

![Карат Земли](https://github.com/HellInsider/DiplomaWork/blob/main/imgsForReadme/EarthMap.png)
    
Выходными данными являются карты высот, построенные нейросетью.
   
## <a id="pipeline">Пайплайн</a>   
Пайплайн состоит из нескольких этапов:   
1. Подготовка датасета   
   1. Разбиение исходной картинки на квадраты 128х128 пикселей.   
       Были варианты разбиения на квадраты со сторонами 64 и 256 пикселей, но они показали результаты хуже.      
   2. Отсеивание неподходящих данных   
     Условия отсеивания квадратов:      
       - Малая средняя интенсивность   
       - Неравномерность распределения HOG   
       - Близость к полюсам    
2. Обучение нейросети   
   Построение и обучение происходило посредством библиотеки Keras в Python.
   Обучение происходило при следующих параметрах:  
   - Размер батча = 32   
   - Optimizer = Adam   
   - Скорость обучения = 0.003   
   - Регуляризация L2 = 1e-5    
   - Размер фильтров дискриминатора: (5, 5)   
   - Размер фильтров генератора: (7, 7)   
4. Получение результатов    
   В процессе обучения каждые N эпох генерировались карты высот.   
   N = {100, 500, 1000, 2500}   
6. Визуализация результатов   
   Построение трехмерной модели в Unity   
  
  Для ускорения процесса чаще всего ограничивался этапами 2 и 3.    

## <a id="model">Модель</a>   
Из-за малого кол-ва данных (12000 картинок) и специфики задачи было решено использовать архитектуру GAN, которая представляет из себя комбинацию двух нейронок (генератор и дискриминатор).   
Задача генератора - научиться генерировать картинки, схожие с обучающими.   
Задача дискриминатора - научиться отличать сгенерированные картинки от исходных.   

![GAN](https://github.com/HellInsider/DiplomaWork/blob/main/imgsForReadme/GAN.png)

Были проведены эксперименты с двумя видами моделей: U-net и Sgan.   
Вторая показала себя лучше.  

U-net:   
![U-net](https://github.com/HellInsider/DiplomaWork/blob/main/imgsForReadme/U-net.png)   
   
SGAN:   
![SGAN](https://github.com/HellInsider/DiplomaWork/blob/main/imgsForReadme/SGAN.png)

## <a id="results">Результаты</a>   
Результаты работы модели SGAN:       
![Sgan_result](https://github.com/HellInsider/DiplomaWork/blob/main/imgsForReadme/Sgan_result.png)   
   
![Sgan_res_unity](https://github.com/HellInsider/DiplomaWork/blob/main/imgsForReadme/Sgan_res_unity.png)   
   
Результаты работы модели U-net:      
![U-net_result](https://github.com/HellInsider/DiplomaWork/blob/main/imgsForReadme/U-net_result.png)   
   
![U-net_res_unity](https://github.com/HellInsider/DiplomaWork/blob/main/imgsForReadme/U-net_res_unity.png)    

## <a id="source">Исходники</a>   
Код нейронок можно найти [здесь](https://github.com/HellInsider/DiplomaWork/blob/main/DiplomaWork.ipynb)
и [здесь](https://github.com/HellInsider/DiplomaWork/blob/main/DiplomaWork%20(U-net).ipynb).   
Код к генератору [тут](https://github.com/HellInsider/DiplomaWork/tree/main/DataGenerator), а к визуализатору [тут](https://github.com/HellInsider/DiplomaWork/tree/main/UnityRenderer).
